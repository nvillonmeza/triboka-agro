{% extends "base.html" %}

{% block title %}Nueva Fijación - Triboka Agro{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-plus-circle me-2"></i>
        Nueva Fijación
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('contract_detail', contract_id=contract.id) }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left"></i>
            Volver al Contrato
        </a>
    </div>
</div>

<!-- Contract Summary -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="bi bi-file-earmark-text me-2"></i>
            Contrato: {{ contract.contract_code }}
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <strong>Comprador:</strong><br>
                <span class="text-primary">{{ contract.buyer_company.name }}</span>
            </div>
            <div class="col-md-3">
                <strong>Producto:</strong><br>
                {{ contract.product_type }} - {{ contract.product_grade }}
            </div>
            <div class="col-md-3">
                <strong>Diferencial:</strong><br>
                <span class="{% if contract.differential_usd >= 0 %}text-success{% else %}text-danger{% endif %}">
                    {% if contract.differential_usd >= 0 %}+{% endif %}{{ contract.differential_usd|currency }}/MT
                </span>
            </div>
            <div class="col-md-3">
                <strong>Volumen Pendiente:</strong><br>
                <span class="text-warning">{{ contract.pending_volume_mt|volume }}</span>
            </div>
        </div>
        
        <div class="mt-3">
            <div class="progress" style="height: 8px;">
                {% set progress_percent = (contract.fixed_volume_mt / contract.total_volume_mt * 100) if contract.total_volume_mt > 0 else 0 %}
                <div class="progress-bar" role="progressbar" 
                     style="width: {{ progress_percent }}%"
                     aria-valuenow="{{ progress_percent }}" 
                     aria-valuemin="0" 
                     aria-valuemax="100">
                </div>
            </div>
            <div class="d-flex justify-content-between mt-1">
                <small class="text-muted">Fijado: {{ contract.fixed_volume_mt|volume }}</small>
                <small class="text-muted">Total: {{ contract.total_volume_mt|volume }}</small>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-currency-dollar me-2"></i>
                    Información de la Fijación
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="fixationForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="fixed_quantity_mt" class="form-label">
                                <i class="bi bi-weight me-1"></i>
                                Cantidad a Fijar (MT) *
                            </label>
                            <input type="number" 
                                   class="form-control" 
                                   id="fixed_quantity_mt" 
                                   name="fixed_quantity_mt" 
                                   step="0.1"
                                   min="0.1"
                                   max="{{ contract.pending_volume_mt }}"
                                   placeholder="0.0"
                                   required>
                            <div class="form-text">
                                Máximo disponible: {{ contract.pending_volume_mt|volume }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="spot_price_usd" class="form-label">
                                <i class="bi bi-graph-up me-1"></i>
                                Precio Spot (USD/MT) *
                            </label>
                            <input type="number" 
                                   class="form-control" 
                                   id="spot_price_usd" 
                                   name="spot_price_usd" 
                                   step="0.01"
                                   min="0"
                                   placeholder="2850.00"
                                   required>
                            <div class="form-text">
                                Precio actual del mercado internacional
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="bi bi-calculator me-1"></i>
                                        Cálculo de Precio Final
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <small class="text-muted">Precio Spot:</small><br>
                                            <strong id="display-spot-price">$0.00/MT</strong>
                                        </div>
                                        <div class="col-md-4">
                                            <small class="text-muted">Diferencial:</small><br>
                                            <strong class="{% if contract.differential_usd >= 0 %}text-success{% else %}text-danger{% endif %}">
                                                {% if contract.differential_usd >= 0 %}+{% endif %}{{ contract.differential_usd|currency }}/MT
                                            </strong>
                                        </div>
                                        <div class="col-md-4">
                                            <small class="text-muted">Precio Final:</small><br>
                                            <strong class="text-primary" id="display-final-price">$0.00/MT</strong>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <small class="text-muted">Cantidad:</small><br>
                                            <strong id="display-quantity">0.0 MT</strong>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted">Valor Total:</small><br>
                                            <strong class="text-success" id="display-total-value">$0.00</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notes" class="form-label">
                            <i class="bi bi-chat-text me-1"></i>
                            Observaciones
                        </label>
                        <textarea class="form-control" 
                                  id="notes" 
                                  name="notes" 
                                  rows="3" 
                                  placeholder="Información adicional sobre esta fijación, condiciones especiales, referencias de mercado..."></textarea>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('contract_detail', contract_id=contract.id) }}" class="btn btn-secondary me-md-2">
                            <i class="bi bi-x-circle me-2"></i>
                            Cancelar
                        </a>
                        <button type="submit" class="btn btn-success" id="submitBtn">
                            <i class="bi bi-check-circle me-2"></i>
                            Registrar Fijación
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Market Info -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-graph-up me-1"></i>
                    Información de Mercado
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Precio Referencial:</span>
                        <strong class="text-info">$2,850.00/MT</strong>
                    </div>
                    <small class="text-muted">{{ contract.product_type }} internacional</small>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Tendencia:</span>
                        <span class="text-success">
                            <i class="bi bi-arrow-up"></i>
                            +2.1% (7 días)
                        </span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Volatilidad:</span>
                        <span class="text-warning">Media</span>
                    </div>
                </div>
                
                <div class="alert alert-info border-0 py-2 px-3 small">
                    <i class="bi bi-lightbulb me-1"></i>
                    <strong>Recomendación:</strong> Precio favorable para fijación. Demanda alta en mercado europeo.
                </div>
            </div>
        </div>
        
        <!-- Contract Progress -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-pie-chart me-1"></i>
                    Progreso del Contrato
                </h6>
            </div>
            <div class="card-body text-center">
                <div class="row">
                    <div class="col-6 mb-3">
                        <div class="border-end">
                            <h4 class="text-success mb-1">{{ contract.fixed_volume_mt|volume }}</h4>
                            <small class="text-muted">Fijado</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <h4 class="text-warning mb-1">{{ contract.pending_volume_mt|volume }}</h4>
                        <small class="text-muted">Pendiente</small>
                    </div>
                </div>
                
                <div class="mb-2">
                    <small class="text-muted">Fijaciones realizadas: {{ contract.fixations|length }}</small>
                </div>
                
                {% if contract.end_date %}
                {% set days_remaining = ((contract.end_date|date_parse).date() - today.date()).days %}
                <div class="alert {% if days_remaining > 7 %}alert-success{% elif days_remaining > 0 %}alert-warning{% else %}alert-danger{% endif %} border-0 py-2 px-3 small">
                    <i class="bi bi-clock me-1"></i>
                    {% if days_remaining > 0 %}
                    Quedan {{ days_remaining }} días para fijar
                    {% elif days_remaining == 0 %}
                    Último día para fijar
                    {% else %}
                    Período de fijación expirado
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Blockchain Status -->
        {% if blockchain_status and blockchain_status.connected %}
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0">
                    <i class="bi bi-shield-check me-1"></i>
                    Blockchain Activo
                </h6>
            </div>
            <div class="card-body">
                <p class="small mb-2">
                    <strong>Red:</strong> {{ blockchain_status.network|title }}<br>
                    <strong>Gas:</strong> ~$0.01 USD estimado
                </p>
                <div class="alert alert-success border-0 py-2 px-3 small">
                    <i class="bi bi-check-circle-fill me-1"></i>
                    La fijación será registrada automáticamente en blockchain
                </div>
            </div>
        </div>
        {% else %}
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    Blockchain Inactivo
                </h6>
            </div>
            <div class="card-body">
                <div class="alert alert-warning border-0 py-2 px-3 small">
                    <i class="bi bi-info-circle-fill me-1"></i>
                    La fijación se guardará solo en base de datos local
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Help -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-question-circle me-1"></i>
                    Ayuda
                </h6>
            </div>
            <div class="card-body">
                <h6>¿Qué es una fijación?</h6>
                <p class="small text-muted">
                    Una fijación es el proceso de establecer el precio final de una 
                    cantidad específica de producto basado en el precio spot actual 
                    del mercado más el diferencial acordado.
                </p>
                
                <h6>Precio Final:</h6>
                <p class="small text-muted">
                    Precio Final = Precio Spot + Diferencial<br>
                    El diferencial puede ser positivo (prima) o negativo (descuento).
                </p>
                
                <h6>Después de la fijación:</h6>
                <p class="small text-muted">
                    La cantidad fijada se descuenta del volumen pendiente del contrato 
                    y queda comprometida para entrega.
                </p>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const quantityInput = document.getElementById('fixed_quantity_mt');
    const spotPriceInput = document.getElementById('spot_price_usd');
    const form = document.getElementById('fixationForm');
    const submitBtn = document.getElementById('submitBtn');
    
    const differential = {{ contract.differential_usd }};
    const maxQuantity = {{ contract.pending_volume_mt }};
    
    // Set default spot price
    spotPriceInput.value = '2850.00';
    
    // Update calculations on input change
    quantityInput.addEventListener('input', updateCalculations);
    spotPriceInput.addEventListener('input', updateCalculations);
    
    function updateCalculations() {
        const quantity = parseFloat(quantityInput.value) || 0;
        const spotPrice = parseFloat(spotPriceInput.value) || 0;
        const finalPrice = spotPrice + differential;
        const totalValue = quantity * finalPrice;
        
        // Update display
        document.getElementById('display-spot-price').textContent = formatCurrency(spotPrice) + '/MT';
        document.getElementById('display-final-price').textContent = formatCurrency(finalPrice) + '/MT';
        document.getElementById('display-quantity').textContent = quantity.toFixed(1) + ' MT';
        document.getElementById('display-total-value').textContent = formatCurrency(totalValue);
        
        // Validation
        validateForm();
    }
    
    function validateForm() {
        const quantity = parseFloat(quantityInput.value) || 0;
        const spotPrice = parseFloat(spotPriceInput.value) || 0;
        
        let valid = true;
        let message = '';
        
        if (quantity <= 0) {
            valid = false;
            message = 'La cantidad debe ser mayor a cero';
        } else if (quantity > maxQuantity) {
            valid = false;
            message = `La cantidad no puede exceder ${maxQuantity.toFixed(1)} MT`;
            quantityInput.setCustomValidity('Excede el volumen disponible');
        } else {
            quantityInput.setCustomValidity('');
        }
        
        if (spotPrice <= 0) {
            valid = false;
            message = 'El precio spot debe ser mayor a cero';
            spotPriceInput.setCustomValidity('Precio inválido');
        } else {
            spotPriceInput.setCustomValidity('');
        }
        
        // Update submit button
        submitBtn.disabled = !valid;
        if (!valid && message) {
            submitBtn.title = message;
        } else {
            submitBtn.title = '';
        }
    }
    
    function formatCurrency(value) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 2
        }).format(value);
    }
    
    // Form validation
    quantityInput.addEventListener('input', function() {
        const quantity = parseFloat(this.value);
        if (quantity && quantity > maxQuantity) {
            this.setCustomValidity(`Máximo disponible: ${maxQuantity.toFixed(1)} MT`);
        } else if (quantity && quantity <= 0) {
            this.setCustomValidity('La cantidad debe ser mayor a cero');
        } else {
            this.setCustomValidity('');
        }
    });
    
    spotPriceInput.addEventListener('input', function() {
        const price = parseFloat(this.value);
        if (price && price <= 0) {
            this.setCustomValidity('El precio debe ser mayor a cero');
        } else if (price && price > 10000) {
            this.setCustomValidity('Precio muy alto, verificar');
        } else {
            this.setCustomValidity('');
        }
    });
    
    // Form submission confirmation
    form.addEventListener('submit', function(e) {
        const quantity = parseFloat(quantityInput.value);
        const spotPrice = parseFloat(spotPriceInput.value);
        const finalPrice = spotPrice + differential;
        const totalValue = quantity * finalPrice;
        
        const confirmation = confirm(
            `¿Confirmar fijación?\n\n` +
            `Cantidad: ${quantity.toFixed(1)} MT\n` +
            `Precio Final: ${formatCurrency(finalPrice)}/MT\n` +
            `Valor Total: ${formatCurrency(totalValue)}\n\n` +
            `Esta acción no se puede deshacer.`
        );
        
        if (!confirmation) {
            e.preventDefault();
        }
    });
    
    // Initial calculation
    updateCalculations();
});

// Add current date for calculations
const today = new Date();
</script>

<style>
.progress-bar {
    background-color: #2E7D32;
}

.form-control:focus, .form-select:focus {
    border-color: #2E7D32;
    box-shadow: 0 0 0 0.2rem rgba(46, 125, 50, 0.25);
}

.card {
    transition: box-shadow 0.2s;
}

.border-end {
    border-right: 1px solid #dee2e6 !important;
}

.alert {
    margin-bottom: 0;
}

#submitBtn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.bg-light {
    background-color: #f8f9fa !important;
}
</style>
{% endblock %}