{% extends "base.html" %}
{% block title %}Usuarios - Triboka Agro{% endblock %}

{% block extra_css %}
<style>
    .user-card {
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .user-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .role-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
    }
    
    .status-active {
        background-color: #28a745;
    }
    
    .status-inactive {
        background-color: #dc3545;
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
        .table-responsive {
            border: none;
        }
        
        .btn-group-sm > .btn, .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div id="initial-users-data" data-users='{{ users|tojson|safe }}' style="display:none;"></div>
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Encabezado -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">
                        <i class="bi bi-people me-2 text-primary"></i>
                        Gestión de Usuarios
                    </h1>
                    <p class="text-muted mb-0">Administra los usuarios del sistema y sus permisos</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="refreshUsers()">
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        Actualizar
                    </button>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newUserModal">
                        <i class="bi bi-plus-circle me-2"></i>
                        Nuevo Usuario
                    </button>
                </div>
            </div>

            <!-- Estadísticas -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h4 class="mb-0" id="totalUsers">0</h4>
                                    <p class="mb-0">Total Usuarios</p>
                                </div>
                                <i class="bi bi-people fs-2"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h4 class="mb-0" id="activeUsers">0</h4>
                                    <p class="mb-0">Usuarios Activos</p>
                                </div>
                                <i class="bi bi-person-check fs-2"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h4 class="mb-0" id="adminUsers">0</h4>
                                    <p class="mb-0">Administradores</p>
                                </div>
                                <i class="bi bi-shield-check fs-2"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h4 class="mb-0" id="operatorUsers">0</h4>
                                    <p class="mb-0">Gerentes</p>
                                </div>
                                <i class="bi bi-person-workspace fs-2"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="filterName" class="form-label">Buscar por nombre</label>
                            <input type="text" class="form-control" id="filterName" placeholder="Nombre del usuario...">
                        </div>
                        <div class="col-md-3">
                            <label for="filterEmail" class="form-label">Buscar por email</label>
                            <input type="text" class="form-control" id="filterEmail" placeholder="Email del usuario...">
                        </div>
                        <div class="col-md-2">
                            <label for="filterRole" class="form-label">Rol</label>
                            <select class="form-select" id="filterRole">
                                <option value="">Todos los roles</option>
                                <option value="admin">Administrador</option>
                                <option value="manager">Gerente</option>
                                <option value="user">Usuario</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="filterStatus" class="form-label">Estado</label>
                            <select class="form-select" id="filterStatus">
                                <option value="">Todos</option>
                                <option value="active">Activos</option>
                                <option value="inactive">Inactivos</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                <i class="bi bi-x-circle me-1"></i>
                                Limpiar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabla de usuarios -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Lista de Usuarios</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Rol</th>
                                    <th>Estado</th>
                                    <th>Último Acceso</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Los usuarios se cargarán aquí dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            Mostrando <span id="showingCount">0</span> de <span id="totalCount">0</span> usuarios
                        </small>
                        <nav aria-label="Paginación de usuarios">
                            <ul class="pagination pagination-sm mb-0" id="pagination">
                                <!-- Paginación se generará dinámicamente -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nuevo Usuario -->
<div class="modal fade" id="newUserModal" tabindex="-1" aria-labelledby="newUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newUserModalLabel">Nuevo Usuario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="newUserForm">
                    <div class="mb-3">
                        <label for="userName" class="form-label">Nombre completo</label>
                        <input type="text" class="form-control" id="userName" required>
                    </div>
                    <div class="mb-3">
                        <label for="userEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="userEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="userPassword" class="form-label">Contraseña</label>
                        <input type="password" class="form-control" id="userPassword" required>
                    </div>
                    <div class="mb-3">
                        <label for="userRole" class="form-label">Rol</label>
                        <select class="form-select" id="userRole" required>
                            <option value="">Seleccionar rol...</option>
                            <option value="admin">Administrador</option>
                            <option value="manager">Gerente</option>
                            <option value="user">Usuario</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="userActive" checked>
                            <label class="form-check-label" for="userActive">
                                Usuario activo
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="createUser()">Crear Usuario</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar Usuario -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">Editar Usuario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    <div class="mb-3">
                        <label for="editUserName" class="form-label">Nombre completo</label>
                        <input type="text" class="form-control" id="editUserName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editUserEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="editUserEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="editUserRole" class="form-label">Rol</label>
                        <select class="form-select" id="editUserRole" required>
                            <option value="admin">Administrador</option>
                            <option value="manager">Gerente</option>
                            <option value="user">Usuario</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="editUserActive">
                            <label class="form-check-label" for="editUserActive">
                                Usuario activo
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editUserPassword" class="form-label">Nueva contraseña (opcional)</label>
                        <input type="password" class="form-control" id="editUserPassword" placeholder="Dejar vacío para mantener la actual">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="updateUser()">Actualizar Usuario</button>
            </div>
        </div>
    </div>
</div>

<script>
const API_BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:5003' : '';
const ACCESS_TOKEN = '{{ access_token }}';

const initialDataElement = document.getElementById('initial-users-data');
const initialUsersData = initialDataElement ? JSON.parse(initialDataElement.dataset.users || '[]') : [];
if (initialDataElement) {
    initialDataElement.remove();
}
let currentUsers = [];
let filteredUsers = [];
let currentPage = 1;
const usersPerPage = 10;

// Cargar usuarios al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    if (Array.isArray(initialUsersData) && initialUsersData.length > 0) {
        currentUsers = initialUsersData;
        filteredUsers = [...currentUsers];
        updateStatistics();
        displayUsers();
        updatePagination();
    }

    loadUsers();
    
    // Event listeners para filtros
    document.getElementById('filterName').addEventListener('input', applyFilters);
    document.getElementById('filterEmail').addEventListener('input', applyFilters);
    document.getElementById('filterRole').addEventListener('change', applyFilters);
    document.getElementById('filterStatus').addEventListener('change', applyFilters);
});

async function loadUsers() {
    try {
        // Hacer petición directamente al backend con JWT
        const apiUrl = `${API_BASE_URL}/api/users`;
        const headers = {
            'Content-Type': 'application/json'
        };
        
        // Usar token JWT directamente al backend
        if (ACCESS_TOKEN) {
            headers['Authorization'] = `Bearer ${ACCESS_TOKEN}`;
        }
        
        const response = await fetch(apiUrl, { 
            method: 'GET',
            headers
            // No necesitamos credentials ya que usamos JWT
        });
        
        if (!response.ok) {
            if (response.status === 401) {
                // Usuario no autenticado, redirigir al login
                window.location.href = '/login';
                return;
            } else if (response.status === 403) {
                showAlert('No tienes permisos para ver los usuarios', 'warning');
                return;
            }
            throw new Error(`HTTP ${response.status}: Error al cargar usuarios`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            // La respuesta no es JSON, probablemente HTML de error
            console.error('Respuesta no es JSON:', await response.text());
            throw new Error('El servidor devolvió una respuesta inválida');
        }
        
        const data = await response.json();
        currentUsers = data || [];  // El backend devuelve array directamente
        filteredUsers = [...currentUsers];
        
        updateStatistics();
        displayUsers();
        updatePagination();
        
        showAlert('Usuarios cargados exitosamente', 'success');
    } catch (error) {
        console.error('Error al cargar usuarios:', error);
        
        // Si hay error de red, mostrar datos simulados para propósitos de demo
        if (error.name === 'TypeError' || error.message.includes('Failed to fetch')) {
            console.warn('Error de conexión, mostrando datos simulados');
            currentUsers = [
                {
                    id: 1,
                    first_name: 'Administrador',
                    last_name: 'Sistema',
                    name: 'Administrador Sistema',
                    email: 'admin@triboka.com',
                    role: 'admin',
                    is_active: true,
                    last_login: '2024-11-05T10:30:00'
                },
                {
                    id: 2,
                    first_name: 'Gerente',
                    last_name: 'Principal',
                    name: 'Gerente Principal',
                    email: 'gerente@triboka.com',
                    role: 'manager',
                    is_active: true,
                    last_login: '2024-11-04T15:45:00'
                },
                {
                    id: 3,
                    first_name: 'Usuario',
                    last_name: 'Visualizador',
                    name: 'Usuario Visualizador',
                    email: 'usuario@triboka.com',
                    role: 'user',
                    is_active: false,
                    last_login: null
                }
            ];
            filteredUsers = [...currentUsers];
            
            updateStatistics();
            displayUsers();
            updatePagination();
            
            showAlert('Mostrando datos de demostración (sin conexión al servidor)', 'info');
        } else {
            showAlert('Error al cargar los usuarios: ' + error.message, 'danger');
        }
    }
}

function updateStatistics() {
    const total = currentUsers.length;
    const active = currentUsers.filter(u => u.is_active).length;
    const admins = currentUsers.filter(u => u.role === 'admin').length;
    const managers = currentUsers.filter(u => u.role === 'manager').length;
    
    document.getElementById('totalUsers').textContent = total;
    document.getElementById('activeUsers').textContent = active;
    document.getElementById('adminUsers').textContent = admins;
    document.getElementById('operatorUsers').textContent = managers;
}

function applyFilters() {
    const nameFilter = document.getElementById('filterName').value.toLowerCase();
    const emailFilter = document.getElementById('filterEmail').value.toLowerCase();
    const roleFilter = document.getElementById('filterRole').value;
    const statusFilter = document.getElementById('filterStatus').value;
    
    filteredUsers = currentUsers.filter(user => {
        const fullName = [user.first_name, user.last_name].filter(n => n).join(' ') || user.name || '';
        const matchName = !nameFilter || fullName.toLowerCase().includes(nameFilter);
        const matchEmail = !emailFilter || (user.email && user.email.toLowerCase().includes(emailFilter));
        const matchRole = !roleFilter || user.role === roleFilter;
        const matchStatus = !statusFilter || 
            (statusFilter === 'active' && user.is_active) ||
            (statusFilter === 'inactive' && !user.is_active);
        
        return matchName && matchEmail && matchRole && matchStatus;
    });
    
    currentPage = 1;
    displayUsers();
    updatePagination();
}

function displayUsers() {
    const tbody = document.getElementById('usersTableBody');
    const startIndex = (currentPage - 1) * usersPerPage;
    const endIndex = startIndex + usersPerPage;
    const usersToShow = filteredUsers.slice(startIndex, endIndex);
    
    tbody.innerHTML = '';
    
    if (usersToShow.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4 text-muted">
                    <i class="bi bi-person-x fs-1 d-block mb-2"></i>
                    No se encontraron usuarios
                </td>
            </tr>
        `;
        return;
    }
    
    usersToShow.forEach(user => {
        // Construir nombre completo desde first_name y last_name
        const fullName = [user.first_name, user.last_name].filter(n => n).join(' ') || user.name || 'Sin nombre';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${user.id}</td>
            <td>
                <div class="d-flex align-items-center">
                    <div class="avatar-sm bg-primary text-white rounded-circle me-2 d-flex align-items-center justify-content-center">
                        ${(fullName || 'U').charAt(0).toUpperCase()}
                    </div>
                    ${fullName}
                </div>
            </td>
            <td>${user.email}</td>
            <td>
                <span class="badge ${getRoleBadgeClass(user.role)}">
                    ${getRoleDisplayName(user.role)}
                </span>
            </td>
            <td>
                <span class="badge ${user.is_active ? 'bg-success' : 'bg-secondary'}">
                    ${user.is_active ? 'Activo' : 'Inactivo'}
                </span>
            </td>
            <td>${user.last_login ? formatDate(user.last_login) : 'Nunca'}</td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="editUser(${user.id})" title="Editar">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="deleteUser(${user.id})" title="Eliminar">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Actualizar contadores
    document.getElementById('showingCount').textContent = usersToShow.length;
    document.getElementById('totalCount').textContent = filteredUsers.length;
}

function getRoleBadgeClass(role) {
    switch(role) {
        case 'admin': return 'bg-danger';
        case 'manager': return 'bg-warning';
        case 'user': return 'bg-info';
        default: return 'bg-secondary';
    }
}

function getRoleDisplayName(role) {
    switch(role) {
        case 'admin': return 'Administrador';
        case 'manager': return 'Gerente';
        case 'user': return 'Usuario';
        default: return 'Sin rol';
    }
}

function updatePagination() {
    const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
    const pagination = document.getElementById('pagination');
    
    pagination.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // Botón anterior
    const prevButton = document.createElement('li');
    prevButton.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevButton.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Anterior</a>`;
    pagination.appendChild(prevButton);
    
    // Números de página
    for (let i = 1; i <= totalPages; i++) {
        const pageButton = document.createElement('li');
        pageButton.className = `page-item ${i === currentPage ? 'active' : ''}`;
        pageButton.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
        pagination.appendChild(pageButton);
    }
    
    // Botón siguiente
    const nextButton = document.createElement('li');
    nextButton.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextButton.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Siguiente</a>`;
    pagination.appendChild(nextButton);
}

function changePage(page) {
    const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
    if (page < 1 || page > totalPages) return;
    
    currentPage = page;
    displayUsers();
    updatePagination();
}

function clearFilters() {
    document.getElementById('filterName').value = '';
    document.getElementById('filterEmail').value = '';
    document.getElementById('filterRole').value = '';
    document.getElementById('filterStatus').value = '';
    applyFilters();
}

function refreshUsers() {
    loadUsers();
}

async function createUser() {
    const nameEl = document.getElementById('userName');
    const emailEl = document.getElementById('userEmail');
    const passwordEl = document.getElementById('userPassword');
    const roleEl = document.getElementById('userRole');
    const isActiveEl = document.getElementById('userActive');
    
    if (!nameEl || !emailEl || !passwordEl || !roleEl || !isActiveEl) {
        console.error('Elementos del formulario no encontrados');
        showAlert('Error interno: elementos del formulario no disponibles', 'error');
        return;
    }
    
    const fullName = nameEl.value || '';
    const email = emailEl.value || '';
    const password = passwordEl.value || '';
    const role = roleEl.value || '';
    const isActive = isActiveEl.checked || false;
    
    if (!fullName || !email || !password || !role) {
        showAlert('Por favor complete todos los campos requeridos', 'warning');
        return;
    }
    
    // Separar nombre completo en first_name y last_name
    const nameParts = fullName.trim().split(' ');
    const first_name = nameParts[0] || '';
    const last_name = nameParts.slice(1).join(' ') || '';
    
    try {
        const apiUrl = `${API_BASE_URL}/api/users`;
        const headers = {
            'Content-Type': 'application/json'
        };
        
        // Usar token JWT directamente al backend
        if (ACCESS_TOKEN) {
            headers['Authorization'] = `Bearer ${ACCESS_TOKEN}`;
        }
        
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
                first_name: first_name,
                last_name: last_name,
                email: email,
                password: password,
                role: role,
                is_active: isActive
            })
            // No necesitamos credentials ya que usamos JWT
        });
        
        if (!response.ok) {
            if (response.status === 401) {
                window.location.href = '/login';
                return;
            } else if (response.status === 403) {
                showAlert('No tienes permisos para crear usuarios', 'warning');
                return;
            }
            throw new Error(`HTTP ${response.status}: Error al crear el usuario`);
        }
        
        const result = await response.json();
        showAlert('Usuario creado exitosamente', 'success');
        
        // Cerrar modal y limpiar formulario
        const modal = bootstrap.Modal.getInstance(document.getElementById('newUserModal'));
        modal.hide();
        document.getElementById('newUserForm').reset();
        
        // Recargar usuarios
        loadUsers();
    } catch (error) {
        console.error('Error:', error);
        
        if (error.name === 'TypeError' || error.message.includes('Failed to fetch')) {
            showAlert('Sin conexión al servidor. Función no disponible en modo demo.', 'warning');
        } else {
            showAlert('Error al crear el usuario: ' + error.message, 'danger');
        }
    }
}

function editUser(userId) {
    const user = currentUsers.find(u => u.id === userId);
    if (!user) return;
    
    // Construir nombre completo desde first_name y last_name
    const fullName = [user.first_name, user.last_name].filter(n => n).join(' ') || user.name || '';
    
    document.getElementById('editUserId').value = user.id;
    document.getElementById('editUserName').value = fullName;
    document.getElementById('editUserEmail').value = user.email || '';
    document.getElementById('editUserRole').value = user.role || '';
    document.getElementById('editUserActive').checked = user.is_active;
    document.getElementById('editUserPassword').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
    modal.show();
}

async function updateUser() {
    const userIdEl = document.getElementById('editUserId');
    const nameEl = document.getElementById('editUserName');
    const emailEl = document.getElementById('editUserEmail');
    const roleEl = document.getElementById('editUserRole');
    const isActiveEl = document.getElementById('editUserActive');
    const passwordEl = document.getElementById('editUserPassword');
    
    if (!userIdEl || !nameEl || !emailEl || !roleEl || !isActiveEl || !passwordEl) {
        console.error('Elementos del formulario de edición no encontrados');
        showAlert('Error interno: elementos del formulario no disponibles', 'error');
        return;
    }
    
    const userId = userIdEl.value || '';
    const fullName = nameEl.value || '';
    const email = emailEl.value || '';
    const role = roleEl.value || '';
    const isActive = isActiveEl.checked || false;
    const password = passwordEl.value || '';
    
    if (!fullName || !email || !role) {
        showAlert('Por favor complete todos los campos requeridos', 'warning');
        return;
    }
    
    // Separar nombre completo en first_name y last_name
    const nameParts = fullName.trim().split(' ');
    const first_name = nameParts[0] || '';
    const last_name = nameParts.slice(1).join(' ') || '';
    
    try {
        const updateData = {
            first_name: first_name,
            last_name: last_name,
            email: email,
            role: role,
            is_active: isActive
        };
        
        if (password) {
            updateData.password = password;
        }
        
        const apiUrl = `${API_BASE_URL}/api/users/${userId}`;
        const headers = {
            'Content-Type': 'application/json'
        };
        
        // Usar token JWT directamente al backend
        if (ACCESS_TOKEN) {
            headers['Authorization'] = `Bearer ${ACCESS_TOKEN}`;
        }
        
        const response = await fetch(apiUrl, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify(updateData)
            // No necesitamos credentials ya que usamos JWT
        });
        
        if (!response.ok) {
            throw new Error('Error al actualizar el usuario');
        }
        
        const result = await response.json();
        showAlert('Usuario actualizado exitosamente', 'success');
        
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
        modal.hide();
        
        // Recargar usuarios
        loadUsers();
    } catch (error) {
        console.error('Error:', error);
        showAlert('Error al actualizar el usuario', 'danger');
    }
}

async function deleteUser(userId) {
    if (!confirm('¿Está seguro de que desea eliminar este usuario? Esta acción no se puede deshacer.')) {
        return;
    }
    
    try {
        const apiUrl = `${API_BASE_URL}/api/users/${userId}`;
        const headers = {};
        
        // Usar token JWT directamente al backend
        if (ACCESS_TOKEN) {
            headers['Authorization'] = `Bearer ${ACCESS_TOKEN}`;
        }
        
        const response = await fetch(apiUrl, {
            method: 'DELETE',
            headers: headers
            // No necesitamos credentials ya que usamos JWT
        });
        
        if (!response.ok) {
            throw new Error('Error al eliminar el usuario');
        }
        
        showAlert('Usuario eliminado exitosamente', 'success');
        loadUsers();
    } catch (error) {
        console.error('Error:', error);
        showAlert('Error al eliminar el usuario', 'danger');
    }
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function showAlert(message, type = 'info') {
    // Crear alerta temporal
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remover después de 5 segundos
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}