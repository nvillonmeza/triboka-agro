{% extends "base.html" %}

{% block title %}Deal Rooms - Triboka Agro{% endblock %}

{% block extra_css %}
<style>
.deal-card {
    transition: transform 0.2s, box-shadow 0.2s;
    cursor: pointer;
}

.deal-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.context-indicator {
    background: linear-gradient(135deg, #2E7D32, #4CAF50);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 500;
}

.deal-status {
    font-size: 0.75rem;
    padding: 2px 8px;
    border-radius: 12px;
}

.status-active {
    background-color: #d4edda;
    color: #155724;
}

.status-draft {
    background-color: #fff3cd;
    color: #856404;
}

.status-closed {
    background-color: #f8d7da;
    color: #721c24;
}

.participant-badge {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 15px;
    padding: 4px 12px;
    font-size: 0.75rem;
    margin: 2px;
    display: inline-block;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-0">
                    <i class="bi bi-handshake me-2 text-primary"></i>
                    Deal Rooms
                </h1>
                <p class="text-muted mb-0">Administra acuerdos entre productores y exportadoras</p>
            </div>
            
            <!-- Indicador de Contexto Actual -->
            <div class="context-indicator">
                <i class="bi bi-diagram-3 me-1"></i>
                {% if active_context.type == 'deal' %}
                    Contexto: Acuerdo #{{ active_context.deal_id }}
                {% else %}
                    Contexto Global
                {% endif %}
            </div>
        </div>
        
        <!-- Botón Crear Nuevo Deal -->
        <div class="mb-4">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createDealModal">
                <i class="bi bi-plus-circle me-2"></i>
                Nuevo Acuerdo
            </button>
        </div>
        
        <!-- Lista de Deals -->
        <div class="row" id="deals-container">
            {% if deals %}
                {% for deal in deals %}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card deal-card h-100" onclick="openDealRoom({{ deal.id }})">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-handshake me-2"></i>
                                Acuerdo #{{ deal.id }}
                            </h5>
                            <span class="deal-status status-{{ deal.status|lower }}">
                                {{ deal.status|title }}
                            </span>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="participant-badge">
                                    <i class="bi bi-building me-1"></i>
                                    {{ deal.producer_company or 'Productor' }}
                                </div>
                                <div class="participant-badge">
                                    <i class="bi bi-arrow-left-right me-1"></i>
                                    ↔
                                </div>
                                <div class="participant-badge">
                                    <i class="bi bi-truck me-1"></i>
                                    {{ deal.exporter_company or 'Exportador' }}
                                </div>
                            </div>
                            
                            {% if deal.description %}
                            <p class="card-text text-muted small">{{ deal.description[:100] }}{% if deal.description|length > 100 %}...{% endif %}</p>
                            {% endif %}
                            
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-calendar me-1"></i>
                                    Creado: {{ deal.created_at | date }}
                                </small>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="bi bi-clock me-1"></i>
                                    {{ deal.updated_at | datetime if deal.updated_at else deal.created_at | datetime }}
                                </small>
                                <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); openDealRoom({{ deal.id }})">
                                    <i class="bi bi-eye me-1"></i>
                                    Ver
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <!-- Estado vacío -->
                <div class="col-12">
                    <div class="card">
                        <div class="card-body text-center py-5">
                            <i class="bi bi-handshake display-4 text-muted mb-3"></i>
                            <h4 class="text-muted">No hay acuerdos activos</h4>
                            <p class="text-muted">Crea tu primer acuerdo entre productores y exportadoras</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createDealModal">
                                <i class="bi bi-plus-circle me-2"></i>
                                Crear Primer Acuerdo
                            </button>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal Crear Nuevo Deal -->
<div class="modal fade" id="createDealModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle me-2"></i>
                    Crear Nuevo Acuerdo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createDealForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="producer_company_id" class="form-label">Empresa Productora</label>
                                <select class="form-select" id="producer_company_id" name="producer_company_id" required>
                                    <option value="">Seleccionar productor...</option>
                                    <!-- Las opciones se cargarán dinámicamente -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="exporter_company_id" class="form-label">Empresa Exportadora</label>
                                <select class="form-select" id="exporter_company_id" name="exporter_company_id" required>
                                    <option value="">Seleccionar exportador...</option>
                                    <!-- Las opciones se cargarán dinámicamente -->
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Descripción del Acuerdo</label>
                        <textarea class="form-control" id="description" name="description" rows="3" 
                                placeholder="Describe los términos principales del acuerdo..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="terms" class="form-label">Términos Detallados</label>
                        <textarea class="form-control" id="terms" name="terms" rows="4" 
                                placeholder="Detalles específicos del acuerdo, condiciones, etc."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-2"></i>
                        Crear Acuerdo
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Cargar empresas para el formulario
    loadCompanies();
    
    // Manejar envío del formulario
    document.getElementById('createDealForm').addEventListener('submit', handleCreateDeal);
});

async function loadCompanies() {
    try {
        const response = await fetch('/api/companies', {
            headers: {
                'Authorization': `Bearer ${sessionStorage.getItem('access_token') || ''}`
            }
        });
        
        if (response.ok) {
            const companies = await response.json();
            
            // Separar por tipo
            const producers = companies.filter(c => c.company_type === 'producer');
            const exporters = companies.filter(c => c.company_type === 'exporter');
            
            // Llenar select de productores
            const producerSelect = document.getElementById('producer_company_id');
            producers.forEach(company => {
                const option = document.createElement('option');
                option.value = company.id;
                option.textContent = company.name;
                producerSelect.appendChild(option);
            });
            
            // Llenar select de exportadores
            const exporterSelect = document.getElementById('exporter_company_id');
            exporters.forEach(company => {
                const option = document.createElement('option');
                option.value = company.id;
                option.textContent = company.name;
                exporterSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error cargando empresas:', error);
    }
}

async function handleCreateDeal(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const dealData = {
        producer_id: parseInt(formData.get('producer_company_id')),
        exporter_id: parseInt(formData.get('exporter_company_id')),
        description: formData.get('description'),
        terms: formData.get('terms'),
        status: 'draft'
    };
    
    try {
        const response = await fetch('/api/deals', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${sessionStorage.getItem('access_token') || ''}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dealData)
        });
        
        if (response.ok) {
            const result = await response.json();
            showToast('Acuerdo creado exitosamente', 'success');
            
            // Cerrar modal y recargar página
            const modal = bootstrap.Modal.getInstance(document.getElementById('createDealModal'));
            modal.hide();
            
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            const error = await response.json();
            showToast(`Error creando acuerdo: ${error.error}`, 'danger');
        }
    } catch (error) {
        console.error('Error creando deal:', error);
        showToast('Error de conexión', 'danger');
    }
}

function openDealRoom(dealId) {
    // Navegar al deal room específico
    window.location.href = `/deal/${dealId}`;
}

function showToast(message, type = 'info') {
    const toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) return;
    
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert">
            <div class="d-flex">
                <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    setTimeout(() => {
        toastElement.remove();
    }, 5000);
}
</script>
{% endblock %}
